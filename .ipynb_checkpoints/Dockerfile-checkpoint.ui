FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Copy source
COPY UI/ /app/UI/
COPY app/ /app/app/
COPY requirements.txt /app/app/requirements.txt
COPY UI/requirements.txt /app/UI/requirements.txt

# Install dependencies:
# 1) Base project requirements (if present)
# 2) UI-specific requirements (if present)
# 3) Ensure FastAPI/uvicorn/jinja2/requests exist for serving + simple proxying
RUN --mount=type=cache,target=/root/.cache/pip \
    (pip install -r /app/app/requirements.txt || true) && \
    (test -f /app/UI/requirements.txt && pip install -r /app/UI/requirements.txt || true) && \
    pip install fastapi uvicorn jinja2 requests

# Non-root runtime user (optional hardening)
RUN useradd -m uiuser
USER uiuser

EXPOSE 8501

# Serve the FastAPI UI app
CMD ["uvicorn", "UI.serve_frontend:app", "--host", "0.0.0.0", "--port", "8501"]
